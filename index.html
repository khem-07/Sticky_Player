<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sticky Player</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
  <style>
    :root {
      --fg: #fff;
      --bg: #222;
    }
    body {
      margin: 0;
      font-family: "Poppins", Arial, sans-serif;
      background: #f7f7f7;
    }
    #sticky-player {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 16px;
      color: var(--fg);
      background: var(--bg);
      box-shadow: 0 0 10px #0002;
      transition: top 0.3s, bottom 0.3s;
    }
    #sticky-player.top {
      top: 0;
      bottom: auto;
    }
    #sticky-player.bottom {
      bottom: 0;
      top: auto;
    }
    #play-stop-btn,
    #toggle-pos-btn {
      display: flex;
      align-items: center;
      background: none;
      border: none;
      color: var(--fg);
      cursor: pointer;
      outline: none;
    }
    #play-stop-btn {
      font-size: 2.2rem;
    }
    #toggle-pos-btn {
      font-size: 1.7rem;
      margin-left: auto;
    }
    #play-stop-btn svg {
      width: 3.2rem;
      height: 3.2rem;
    }
    #song-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }
    .track-line {
      position: relative;
      height: 1.5em;
      line-height: 1.5em;
      font-weight: 400;
      letter-spacing: 0.4px;
      font-size: 1.1rem;
    }
    #artist-name {
      opacity: 0.75;
      font-size: 1.05rem;
    }
    .marquee {
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }
    .marquee > div {
      display: flex;
      gap: 64px;
      position: absolute;
      white-space: nowrap;
      will-change: transform;
      animation: scroll-left 14s linear infinite;
    }
    .marquee:hover > div,
    .marquee:focus-within > div {
      animation-play-state: paused;
    }
    @keyframes scroll-left {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-100%);
      }
    }
    .debug-info {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #000d;
      color: #fff;
      font: 11px monospace;
      padding: 10px;
      border-radius: 5px;
      max-width: 240px;
      z-index: 1001;
    }
    @media (max-width: 600px) {
      #sticky-player {
        padding: 8px;
        gap: 10px;
      }
      #play-stop-btn {
        font-size: 1.5rem;
      }
      #toggle-pos-btn {
        font-size: 1.3rem;
      }
      #artist-name {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div id="sticky-player" class="bottom">
    <button id="play-stop-btn" aria-label="Play">
      <svg id="play-svg" viewBox="0 0 38 38" fill="none"><circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2"/><polygon points="15,12 28,19 15,26" fill="currentColor"/></svg>
      <svg id="stop-svg" viewBox="0 0 38 38" fill="none" style="display:none;"><circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2"/><rect x="14" y="14" width="10" height="10" fill="currentColor"/></svg>
      <svg id="loading-svg" viewBox="0 0 38 38" fill="none" style="display:none;"><circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2" opacity="0.2"/><circle cx="19" cy="19" r="15" stroke="currentColor" stroke-width="3" stroke-dasharray="25,20" stroke-linecap="round" fill="none"><animateTransform attributeName="transform" type="rotate" from="0 19 19" to="360 19 19" dur="1s" repeatCount="indefinite"/></circle></svg>
    </button>
    <div id="song-info">
      <div class="track-line marquee" id="artist-name"><div><span>Ramasha Media</span><span>Ramasha Media</span></div></div>
      <div class="track-line marquee" id="song-title"><div><span>Loading…</span><span>Loading…</span></div></div>
    </div>
    <button id="toggle-pos-btn" aria-label="Toggle position"><i class="bi bi-chevron-up" id="toggle-arrow"></i></button>
  </div>
  <div id="debug-info" class="debug-info" style="display:none;">
    <div><strong>Debug Info</strong></div>
    <div>Updates: <span id="update-count">0</span></div>
    <div>Last : <span id="last-update">-</span></div>
    <div>Status: <span id="api-status">-</span></div>
    <div>Raw : <span id="raw-data">-</span></div>
    <button style="margin-top:5px;font-size:10px" onclick="debugInfo.style.display='none'">Hide</button>
  </div>
  <audio id="audio" preload="none"></audio>
  <script>
    const STREAM_URL = "https://listen.ramashamedia.com:8330/stream";
    const SONG_API = "/api/currentsong";
    const $ = id => document.getElementById(id);

    const audio = $("audio"),
          playBtn = $("play-stop-btn"),
          playSvg = $("play-svg"),
          stopSvg = $("stop-svg"),
          loadingSvg = $("loading-svg"),
          songTitleEl = $("song-title"),
          artistNameEl = $("artist-name"),
          sticky = $("sticky-player"),
          toggleArrow = $("toggle-arrow"),
          debugInfo = $("debug-info"),
          updateCountEl = $("update-count"),
          lastUpdateEl = $("last-update"),
          apiStatusEl = $("api-status"),
          rawDataEl = $("raw-data");

    let playing = false, updates = 0;

    async function fetchSong() {
      const r = await fetch(`${SONG_API}?_=${Date.now()}`);
      if (!r.ok) throw new Error("network");
      const d = await r.json();
      if (!d.success) throw new Error(d.error || "api");
      return d;
    }

    function setMarqueeText(el, text) {
      const inner = el.querySelector("div");
      inner.innerHTML = `<span>${text}</span><span>${text}</span>`;
    }

    async function updateInfo() {
      updateCountEl.textContent = ++updates;
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
      apiStatusEl.textContent = "...";
      try {
        const d = await fetchSong();
        setMarqueeText(songTitleEl, d.title || "No track information");
        setMarqueeText(artistNameEl, d.artist || "Ramasha Media");
        apiStatusEl.textContent = "ok";
        rawDataEl.textContent = (d.raw || "").slice(0, 30) + "…";
      } catch (e) {
        setMarqueeText(songTitleEl, "Error");
        setMarqueeText(artistNameEl, "");
        apiStatusEl.textContent = e.message;
      }
    }

    playBtn.addEventListener("click", async () => {
      if (playing) {
        audio.pause();
        audio.src = "";
        playing = false;
        playSvg.style.display = "block";
        stopSvg.style.display = "none";
      } else {
        try {
          playSvg.style.display = "none";
          loadingSvg.style.display = "block";
          audio.src = STREAM_URL;
          await audio.play();
          playing = true;
          loadingSvg.style.display = "none";
          stopSvg.style.display = "block";
          updateInfo();
        } catch (e) {
          loadingSvg.style.display = "none";
          playSvg.style.display = "block";
          alert("Can't play: " + e.message);
        }
      }
    });

    $("toggle-pos-btn").addEventListener("click", () => {
      const bottom = sticky.classList.toggle("bottom");
      sticky.classList.toggle("top", !bottom);
      toggleArrow.classList.toggle("bi-chevron-up", bottom);
      toggleArrow.classList.toggle("bi-chevron-down", !bottom);
    });

    let clicks = 0;
    document.addEventListener("click", () => {
      clicks++;
      setTimeout(() => (clicks = 0), 500);
      if (clicks === 3) debugInfo.style.display = debugInfo.style.display === "none" ? "block" : "none";
    });

    window.addEventListener("resize", () => setTimeout(updateInfo, 200));

    updateInfo();
    setInterval(updateInfo, 15000);
  </script>
</body>
</html>
