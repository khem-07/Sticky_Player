<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sticky Player</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Rancho&family=Poppins:wght@400;700&display=swap" rel="stylesheet"/>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<style>
:root {
  --play-btn-color: #fff;
  --text-color: #fff;
  --bg-color: #222;
}
body {
  font-family: 'Poppins', Arial, sans-serif;
  margin: 0;
}
#sticky-player {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-color);
  color: var(--text-color);
  display: flex;
  align-items: center;
  padding: 12px 16px;
  z-index: 1000;
  box-shadow: 0 0 10px #0002;
  transition: top 0.3s, bottom 0.3s;
  overflow: hidden;
}
#sticky-player.top   { top: 0;    bottom: auto; }
#sticky-player.bottom{ bottom: 0; top: auto;  }

#play-stop-btn {
  background: none;
  border: none;
  color: var(--play-btn-color);
  font-size: 2.2rem;
  margin-right: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
}
#play-stop-btn svg   { width: 3.2rem; height: 3.2rem; display: block; }

#song-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.title-mask,
.artist-mask {
  position: relative;
  overflow: hidden;
}
.title-mask  { height: 1.5em; mask-image: linear-gradient(to right, black 80%, transparent); }
.artist-mask { height: 1.2em; mask-image: linear-gradient(to left , black 80%, transparent); }

#song-title {
  font-family: 'Rancho', cursive;
  font-size: 1.3rem;
  white-space: nowrap;
  display: inline-block;
}
#artist-name {
  font-size: .98em;
  opacity: .75;
  white-space: nowrap;
  display: inline-block;
  text-align: right;
}
.marquee { will-change: transform; }

#toggle-pos-btn {
  background: none;
  border: none;
  color: var(--play-btn-color);
  font-size: 1.7rem;
  margin-left: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
}
#toggle-arrow { opacity: .7; }

.debug-info {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,.9);
  color: #fff;
  padding: 10px;
  border-radius: 5px;
  font-size: 11px;
  max-width: 250px;
  z-index: 1001;
  font-family: monospace;
}
@media (max-width: 600px){
  #sticky-player      { padding: 8px; }
  #play-stop-btn      { font-size: 1.5rem; margin-right: 10px; }
  #toggle-pos-btn     { font-size: 1.3rem; margin-left: 8px; }
  #song-title         { font-size: 1.05rem; }
  .artist-mask        { max-width: 90px; }
  #artist-name        { font-size: .93em; }
  .debug-info         { display: none; }
}
</style>
</head>
<body>

<div id="sticky-player" class="bottom">
  <!-- main play/stop button -->
  <button id="play-stop-btn" aria-label="Play">
    <svg id="play-svg" viewBox="0 0 38 38" fill="none">
      <circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2"/>
      <polygon points="15,12 28,19 15,26" fill="currentColor"/>
    </svg>
    <svg id="stop-svg" viewBox="0 0 38 38" fill="none" style="display:none">
      <circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2"/>
      <rect x="14" y="14" width="10" height="10" fill="currentColor"/>
    </svg>
    <svg id="loading-svg" viewBox="0 0 38 38" fill="none" style="display:none">
      <circle cx="19" cy="19" r="17.5" stroke="currentColor" stroke-width="2" opacity="0.25"/>
      <circle cx="19" cy="19" r="15" stroke="currentColor" stroke-width="3" stroke-dasharray="25, 20" stroke-linecap="round" fill="none">
        <animateTransform attributeName="transform" type="rotate" from="0 19 19" to="360 19 19" dur="1s" repeatCount="indefinite"/>
      </circle>
    </svg>
  </button>

  <!-- song / artist -->
  <div id="song-info">
    <span class="title-mask"><span id="song-title">Loading…</span></span>
    <span class="artist-mask"><span id="artist-name"></span></span>
  </div>

  <!-- position‑toggle button -->
  <button id="toggle-pos-btn" aria-label="Toggle position">
    <i class="bi bi-chevron-up" id="toggle-arrow"></i>
  </button>
</div>

<!-- optional debug panel (triple‑click anywhere to toggle) -->
<div id="debug-info" class="debug-info" style="display:none">
  <div><strong>Debug Info</strong></div>
  <div>Updates: <span id="update-count">0</span></div>
  <div>Last : <span id="last-update">-</span></div>
  <div>Status: <span id="api-status">-</span></div>
  <div>Raw  : <span id="raw-data">-</span></div>
  <button onclick="debugInfo.style.display='none'" style="margin-top:5px;font-size:10px">Hide</button>
</div>

<audio id="audio" preload="none"></audio>

<script>
const STREAM_URL = 'https://listen.ramashamedia.com:8330/stream';
const SONG_API   = '/api/currentsong';

const audio        = document.getElementById('audio');
const playBtn      = document.getElementById('play-stop-btn');
const playSvg      = document.getElementById('play-svg');
const stopSvg      = document.getElementById('stop-svg');
const loadingSvg   = document.getElementById('loading-svg');
const songTitleEl  = document.getElementById('song-title');
const artistNameEl = document.getElementById('artist-name');
const stickyPlayer = document.getElementById('sticky-player');
const togglePosBtn = document.getElementById('toggle-pos-btn');
const toggleArrow  = document.getElementById('toggle-arrow');

const debugInfo     = document.getElementById('debug-info');
const updateCountEl = document.getElementById('update-count');
const lastUpdateEl  = document.getElementById('last-update');
const apiStatusEl   = document.getElementById('api-status');
const rawDataEl     = document.getElementById('raw-data');

let isPlaying   = false;
let updateCount = 0;

/* ------------------------------- API helpers ------------------------------ */
async function fetchSongTitle(){
  const resp = await fetch(SONG_API + '?_=' + Date.now());
  if (!resp.ok) throw new Error('Error loading');
  const data = await resp.json();
  if (!data.success) throw new Error(data.error || 'No title');
  return data;
}

async function updateSongInfo(){
  updateCount++;
  updateCountEl.textContent = updateCount;
  lastUpdateEl.textContent  = new Date().toLocaleTimeString();
  apiStatusEl.textContent   = 'Fetching…';

  try{
    const data = await fetchSongTitle();
    apiStatusEl.textContent = 'Success';
    rawDataEl.textContent   = (data.raw || '').substring(0,30) + '…';

    songTitleEl.textContent  = data.title  || 'No track information';
    artistNameEl.textContent = data.artist || 'Ramasha Media';

    applyMarquee();
  }catch(err){
    songTitleEl.textContent  = err.message === 'No title' ? 'No title' : 'Error loading';
    artistNameEl.textContent = '';
    apiStatusEl.textContent  = 'Failed: ' + err.message;
    resetMarquee(songTitleEl);
    resetMarquee(artistNameEl);
  }
}

/* ------------------------------ marquee helpers --------------------------- */
function resetMarquee(el){
  el.classList.remove('marquee');
  el.style.animation = '';
}

function applyMarquee(){
  resetMarquee(songTitleEl);
  resetMarquee(artistNameEl);

  // remove old dynamic style tag
  const old = document.getElementById('dynamic-marquee-keyframes');
  if (old) old.remove();

  // strip any duplicate text injected previously
  songTitleEl.innerHTML  = songTitleEl.textContent;
  artistNameEl.innerHTML = artistNameEl.textContent;

  requestAnimationFrame(()=>{
    /* --- title marquee (L→R) --- */
    const titleMask  = songTitleEl.parentElement;
    const titleW     = songTitleEl.scrollWidth;
    const titleMaskW = titleMask.clientWidth;

    let css = '';

    if (titleW > titleMaskW){
      songTitleEl.innerHTML += ' <span class="marquee-copy">' + songTitleEl.textContent + '</span>';
      const distance = titleW + 20;
      const speed    = 40;               // px per second
      const dur      = distance / speed;

      css += `@keyframes title-marquee{0%{transform:translateX(0)}100%{transform:translateX(-${distance}px)}}`;
      songTitleEl.classList.add('marquee');
      songTitleEl.style.animation = `title-marquee ${dur}s linear infinite`;
    }

    /* --- artist marquee (starts at chevron) --- */
    const artistMask  = artistNameEl.parentElement;
    const artistW     = artistNameEl.scrollWidth;
    const artistMaskW = artistMask.clientWidth;

    if (artistW > artistMaskW){
      artistNameEl.innerHTML += ' <span class="marquee-copy">' + artistNameEl.textContent + '</span>';

      // distance from artist mask's left edge to chevron's left edge
      const chevronLeft = togglePosBtn.getBoundingClientRect().left;
      const maskLeft    = artistMask.getBoundingClientRect().left;
      const startPos    = chevronLeft - maskLeft;         // px

      // total scroll distance: the text width plus extra beyond the left
      const scrollDist  = artistW + Math.abs(startPos) + 80;
      const speed       = 40;
      const durA        = scrollDist / speed;

      css += `@keyframes artist-marquee{0%{transform:translateX(${startPos}px)}100%{transform:translateX(-${artistW + 20}px)}}`;
      artistNameEl.classList.add('marquee');
      artistNameEl.style.animation = `artist-marquee ${durA}s linear infinite`;
    }

    /* inject combined keyframes (if any) */
    if (css){
      const style = document.createElement('style');
      style.id = 'dynamic-marquee-keyframes';
      style.textContent = css;
      document.head.appendChild(style);
    }
  });
}

/* ------------------------------ UI handlers ------------------------------- */
playBtn.addEventListener('click', async ()=>{
  if (isPlaying){
    audio.pause();
    audio.src = '';
    isPlaying = false;
    playSvg.style.display    = 'block';
    stopSvg.style.display    = 'none';
    loadingSvg.style.display = 'none';
  }else{
    try{
      playSvg.style.display    = 'none';
      stopSvg.style.display    = 'none';
      loadingSvg.style.display = 'block';

      audio.src = STREAM_URL;
      await audio.play();

      isPlaying = true;
      loadingSvg.style.display = 'none';
      stopSvg.style.display    = 'block';

      updateSongInfo();
    }catch(e){
      isPlaying = false;
      loadingSvg.style.display = 'none';
      playSvg.style.display    = 'block';
      stopSvg.style.display    = 'none';
      alert('Unable to play stream: ' + e.message);
    }
  }
});

audio.addEventListener('play',  updateSongInfo);
audio.addEventListener('pause', ()=>{ if (audio.ended || audio.error){ isPlaying=false; playSvg.style.display='block'; stopSvg.style.display='none'; }});
audio.addEventListener('ended', ()=>{ isPlaying=false; playSvg.style.display='block'; stopSvg.style.display='none'; });
audio.addEventListener('error', ()=>{ isPlaying=false; playSvg.style.display='block'; stopSvg.style.display='none'; });

togglePosBtn.addEventListener('click', ()=>{
  const toBottom = stickyPlayer.classList.toggle('bottom');
  stickyPlayer.classList.toggle('top', !toBottom);

  toggleArrow.classList.toggle('bi-chevron-up',   toBottom);
  toggleArrow.classList.toggle('bi-chevron-down', !toBottom);

  // re‑compute marquee after layout shift
  setTimeout(applyMarquee, 100);
});

/* triple‑click anywhere toggles debug panel */
let clicks = 0;
document.addEventListener('click', ()=>{
  clicks++;
  setTimeout(()=>clicks=0, 500);
  if (clicks === 3){
    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
  }
});

/* keep marquee in sync with viewport changes */
window.addEventListener('resize', ()=> setTimeout(applyMarquee,100));

/* initial run */
updateSongInfo();
setInterval(updateSongInfo, 10000);
</script>
</body>
</html>
